<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VRL Travels | In-Seat Feedback</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --vrl-primary: #f2c508;
      --vrl-dark: #cc9d00;
    }

    .rating-stars {
      display: flex;
      justify-content: center;
      flex-direction: row-reverse;
      font-size: 3rem;
    }
    .rating-stars input { display: none; }
    .rating-stars label {
      color: #ccc;
      cursor: pointer;
      padding: 0 0.25rem;
    }
    .rating-stars label:before { content: '‚òÖ'; }
    .rating-stars input:checked ~ label,
    .rating-stars label:hover,
    .rating-stars label:hover ~ label {
      color: gold;
    }

    .tile-checked {
      background-color: var(--vrl-primary);
      color: black;
      font-weight: 700;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

<div class="max-w-xl mx-auto bg-white shadow-xl rounded-b-xl overflow-hidden">

  <!-- HEADER -->
  <header class="bg-yellow-400 p-4 flex items-center gap-4">
    <img src="https://i.ibb.co/rGt0W4kb/Vijayananad-Logo-210623-05.png" class="h-14" />
    <div>
      <h1 class="text-xl font-extrabold">Quick Journey Feedback</h1>
      <p class="text-sm">Help us improve your SuperBus experience</p>
    </div>
  </header>

  <!-- FORM -->
  <form id="feedbackForm" class="p-6 space-y-6">

    <!-- TRIP INFO -->
    <div class="bg-yellow-100 p-4 rounded">
      <p><b>Bus:</b> <span id="busDisplay">Loading‚Ä¶</span></p>
      <p><b>Route:</b> <span id="routeDisplay">Fetching‚Ä¶</span></p>
    </div>
<!--Name and ETC -->
    <section>
  <h2 class="font-bold mb-2">Your Details </h2>

  <input id="customerName"
    placeholder="Your Name"
    class="w-full p-3 border rounded mb-2">

  <input id="customerPhone"
    placeholder="Mobile Number"
    pattern="[0-9]{10}"
    class="w-full p-3 border rounded">
</section>
    
    <!-- RATING -->
    <section>
      <h2 class="font-bold mb-2">Overall Experience</h2>
      <div class="rating-stars">
        <input type="radio" id="s5" name="rating" value="5" required><label for="s5"></label>
        <input type="radio" id="s4" name="rating" value="4"><label for="s4"></label>
        <input type="radio" id="s3" name="rating" value="3"><label for="s3"></label>
        <input type="radio" id="s2" name="rating" value="2"><label for="s2"></label>
        <input type="radio" id="s1" name="rating" value="1"><label for="s1"></label>
      </div>
    </section>

    <!-- ISSUE -->
    <section>
      <h2 class="font-bold mb-2">Main Area of Concern</h2>
      <div id="issues" class="flex flex-wrap gap-2">
        <label class="issue px-4 py-2 bg-gray-100 rounded cursor-pointer">
          <input type="radio" name="issue" value="Bus Condition" hidden required> üöå Bus Condition
        </label>
        <label class="issue px-4 py-2 bg-gray-100 rounded cursor-pointer">
          <input type="radio" name="issue" value="Punctuality" hidden> ‚è∞ Punctuality
        </label>
        <label class="issue px-4 py-2 bg-gray-100 rounded cursor-pointer">
          <input type="radio" name="issue" value="Staff Behaviour" hidden> ü§ù Staff Behaviour
        </label>
        <label class="issue px-4 py-2 bg-gray-100 rounded cursor-pointer">
          <input type="radio" name="issue" value="Other" hidden> ü§∑ Other
        </label>
      </div>
    </section>

    <!-- FEEDBACK TEXT -->
    <section>
      <textarea id="feedbackText" rows="4" maxlength="500"
        placeholder="Tell us what went wrong (optional)"
        class="w-full p-3 border rounded"></textarea>
    </section>

    <!-- SUBMIT -->
    <button type="submit"
      class="w-full py-4 bg-yellow-400 text-black font-extrabold rounded-xl">
      Submit Feedback
    </button>

    <p id="status" class="text-center font-semibold hidden"></p>

  </form>
</div>

<script>
/* =========================================================
   SUPABASE CONFIG (YOUR PROJECT)
========================================================= */
const SUPABASE_URL = "https://ctoqxiaafjemchnohphc.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_nZ_WpKzyNVmunXo_sEKtWQ_-_c-j4ym";

/* =========================================================
   GET BUS ID FROM QR
========================================================= */
const params = new URLSearchParams(window.location.search);
const BUS_ID = params.get("bus_id");

const busDisplay = document.getElementById("busDisplay");
const routeDisplay = document.getElementById("routeDisplay");
const statusEl = document.getElementById("status");

busDisplay.textContent = BUS_ID || "Unknown";

/* =========================================================
   FETCH TODAY'S ROUTE FOR BUS
========================================================= */
async function fetchRoute() {
  if (!BUS_ID) {
    routeDisplay.textContent = "Unknown route";
    return null;
  }

  const today = new Date().toISOString().split("T")[0];

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/daily_bus_routes?bus_id=eq.${BUS_ID}&service_date=eq.${today}`,
    {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`
      }
    }
  );

  const data = await res.json();

  if (data.length > 0) {
    routeDisplay.textContent = `${data[0].route_from} ‚Üí ${data[0].route_to}`;
    return data[0];
  } else {
    routeDisplay.textContent = "Route not uploaded yet";
    return null;
  }
}

/* =========================================================
   SUBMIT FEEDBACK
========================================================= */
document.getElementById("feedbackForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  statusEl.classList.remove("hidden");
  statusEl.textContent = "Submitting‚Ä¶";

  const route = await fetchRoute();

  const rating = document.querySelector("input[name=rating]:checked").value;
  const issue = document.querySelector("input[name=issue]:checked").value;
  const feedbackText = document.getElementById("feedbackText").value;

  const name = document.getElementById("customerName").value.trim();
  const phone = document.getElementById("customerPhone").value.trim();

  await fetch(`${SUPABASE_URL}/rest/v1/feedback`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      bus_id: BUS_ID,
      route_from: route?.route_from || null,
      route_to: route?.route_to || null,
      rating: Number(rating),
      issue,
      feedback_text: feedbackText || null,
      customer_name: name || null,
      customer_phone: phone || null,
      source: "QR"
    })
  });

  statusEl.textContent = "‚úÖ Feedback received. Thank you!";
  document.querySelectorAll("input, textarea, button").forEach(el => el.disabled = true);
});

/* =========================================================
   UI TILE TOGGLE
========================================================= */
document.querySelectorAll(".issue").forEach(label => {
  label.addEventListener("click", () => {
    document.querySelectorAll(".issue").forEach(l => l.classList.remove("tile-checked"));
    label.classList.add("tile-checked");
  });
});

/* INIT */
fetchRoute();
</script>

</body>
</html>
